#!/bin/bash

#----------------------------------------------------
# 설정: 여기에 확인할 PM2 프로세스 ID를 나열합니다.
#----------------------------------------------------
IDS_TO_CHECK=(0 1 2 3 4 5)

# 스크립트 실행 중 예기치 않은 오류 발생 시 즉시 중단 (더 안전한 실행을 위함)
set -e

# 사전 확인 단계에서 사용할 플래그 변수
ALL_IDS_EXIST=true

#====================================================
# 1. 사전 확인 (Pre-check)
#====================================================
echo "========================================"
echo "PM2 프로세스 존재 여부를 사전 확인합니다..."
echo "========================================"

for id in "${IDS_TO_CHECK[@]}"; do
  # pm2 describe [id] 명령어는 ID가 존재하면 성공(종료 코드 0), 없으면 실패(종료 코드 1)를 반환합니다.
  # > /dev/null 2>&1 은 성공/실패 여부와 관계없이 화면에 출력되는 메시지를 모두 숨겨줍니다.
  if pm2 describe "$id" > /dev/null 2>&1; then
    echo "  [✅] ID $id 확인: 존재합니다."
  else
    echo "  [❌] ID $id 확인: 존재하지 않습니다!"
    ALL_IDS_EXIST=false
  fi
done

echo "" # 줄바꿈

#====================================================
# 2. 확인 결과에 따른 실행 또는 중단
#====================================================
# 만약 확인 과정에서 ID가 하나라도 없었다면, 스크립트를 여기서 중단합니다.
if [ "$ALL_IDS_EXIST" = false ]; then
  echo "========================================"
  echo "오류: 필요한 PM2 프로세스가 모두 존재하지 않습니다."
  echo "재시작 작업을 중단합니다."
  echo "========================================"
  exit 1
fi

# 모든 ID가 존재하면 재시작 절차를 시작합니다.
echo "========================================"
echo "모든 필수 프로세스가 확인되었습니다."
echo "프로세스 순차 재시작을 시작합니다."
echo "(각 단계 후 5초 대기)"
echo "========================================"
echo "" # 줄바꿈

#====================================================
# 3. 순차적 재시작 실행
#====================================================
# 1단계: ID 0, 3 재시작
echo "--> 1단계: ID 0번과 3번 재시작 중..."
pm2 restart 0
pm2 restart 3
echo "--> 1단계 완료."
echo ""

# 5초 대기
echo "--> 다음 단계를 위해 5초간 대기합니다..."
sleep 5
echo ""

# 2단계: ID 1, 4 재시작
echo "--> 2단계: ID 1번과 4번 재시작 중..."
pm2 restart 1
pm2 restart 4
echo "--> 2단계 완료."
echo ""

# 5초 대기
echo "--> 다음 단계를 위해 5초간 대기합니다..."
sleep 5
echo ""

# 3단계: ID 2, 5 재시작
echo "--> 3단계: ID 2번과 5번 재시작 중..."
pm2 restart 2
pm2 restart 5
echo "--> 3단계 완료."
echo ""

#====================================================
# 4. 최종 결과 확인
#====================================================
echo "========================================"
echo "모든 PM2 프로세스 재시작이 완료되었습니다."
echo "최종 프로세스 상태:"
pm2 list
echo "========================================"
